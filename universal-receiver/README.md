# üåê R√©cepteur Universel de Casting HLS S√©curis√©

Un syst√®me de casting universel qui fonctionne sur **tous les appareils** supportant le streaming : Chromecast, Android TV, AirPlay, DLNA, et plus.

## üéØ Probl√®me r√©solu

**Le d√©fi** : Les flux HLS s√©curis√©s avec tokens d'authentification ne fonctionnent pas correctement sur les appareils de casting standard car les segments vid√©o sont charg√©s sans pr√©server l'authentification.

**Notre solution** : Un syst√®me universel qui :
- ‚úÖ **D√©tecte automatiquement** le type d'appareil disponible
- ‚úÖ **Route intelligemment** vers la m√©thode appropri√©e
- ‚úÖ **Pr√©serve l'authentification** pour tous les segments
- ‚úÖ **Fournit des fallbacks** en cas d'√©chec
- ‚úÖ **Supporte tous les protocoles** de casting majeurs

## üèóÔ∏è Architecture

```
üì± Application Mobile
    ‚Üì
üß† Syst√®me de D√©tection Universel
    ‚Üì
üîÄ Router Intelligent
   ‚îú‚îÄ‚îÄ üì° Chromecast (r√©cepteur web)
   ‚îú‚îÄ‚îÄ üì∫ Android TV (app native)
   ‚îú‚îÄ‚îÄ üì± AirPlay (API native)
   ‚îú‚îÄ‚îÄ üåê DLNA/UPnP
   ‚îî‚îÄ‚îÄ üîÑ Strat√©gies de fallback
```

## üì¶ Contenu du projet

```
universal-receiver/
‚îú‚îÄ‚îÄ üåê web/
‚îÇ   ‚îú‚îÄ‚îÄ index.html          # R√©cepteur web universel
‚îÇ   ‚îî‚îÄ‚îÄ test.html           # Interface de test
‚îú‚îÄ‚îÄ üì∫ android-tv/
‚îÇ   ‚îú‚îÄ‚îÄ app/                # Application Android TV native
‚îÇ   ‚îú‚îÄ‚îÄ MainActivity.kt     # Activit√© principale
‚îÇ   ‚îî‚îÄ‚îÄ layout/             # Interfaces utilisateur
‚îú‚îÄ‚îÄ üîß src/
‚îÇ   ‚îî‚îÄ‚îÄ universal-casting.ts # Syst√®me de casting universel
‚îî‚îÄ‚îÄ üìñ docs/               # Documentation compl√®te
```

## üöÄ Installation et d√©ploiement

### 1. Int√©gration dans votre app Capacitor

```bash
# Installer le plugin (avec les nouvelles fonctionnalit√©s)
npm install @caprockapps/capacitor-chromecast

# Importer le syst√®me universel
```

```typescript
import { universalCasting, CastDeviceType } from '@caprockapps/capacitor-chromecast/universal-casting';

// D√©couvrir les appareils disponibles
const devices = await universalCasting.discoverDevices();
console.log('Appareils trouv√©s:', devices);

// Caster de mani√®re universelle
const result = await universalCasting.castStream({
  contentId: 'https://example.com/stream.m3u8?token=xxx',
  authToken: 'your_auth_token',
  metadata: {
    title: 'Mon Stream S√©curis√©',
    subtitle: 'Avec authentification'
  },
  preferredDeviceType: CastDeviceType.CHROMECAST,
  fallbackStrategy: 'intent'
});

console.log('R√©sultat:', result);
```

### 2. D√©ployer le r√©cepteur web (Chromecast)

```bash
# 1. H√©berger le r√©cepteur web
cd universal-receiver/web
npm start          # Test local
npm run tunnel     # Tunnel public HTTPS

# 2. Enregistrer sur Google Cast Console
# https://cast.google.com/publish/
# URL: https://votre-domaine.com/universal-receiver/web/index.html
```

### 3. Installer l'app Android TV

```bash
# 1. Compiler l'APK
cd universal-receiver/android-tv
./gradlew assembleRelease

# 2. Installer sur Android TV
adb install app/build/outputs/apk/release/app-release.apk

# 3. Configurer les intents dans votre app principale
```

## üéÆ Utilisation

### API Simple - D√©tection automatique

```typescript
import { universalCasting } from '@caprockapps/capacitor-chromecast/universal-casting';

// Le plus simple - d√©tection et casting automatiques
const result = await universalCasting.castStream({
  contentId: 'https://example.com/stream.m3u8?token=xxx',
  authToken: 'your_token'
});

if (result.success) {
  console.log(`‚úÖ Casting r√©ussi vers ${result.deviceType} via ${result.method}`);
} else {
  console.log(`‚ùå Erreur: ${result.message}`);
}
```

### API Avanc√©e - Contr√¥le pr√©cis

```typescript
// 1. D√©couvrir les appareils sp√©cifiques
const devices = await universalCasting.discoverDevices();
const androidTVs = devices.filter(d => d.type === CastDeviceType.ANDROID_TV);

// 2. Configurer des strat√©gies de fallback
const result = await universalCasting.castStream({
  contentId: 'https://example.com/secure-stream.m3u8',
  authToken: 'jwt_token_here',
  metadata: {
    title: 'Film Premium',
    subtitle: 'Qualit√© 4K',
    description: 'Un film incroyable',
    image: 'https://example.com/poster.jpg',
    duration: 7200 // 2 heures
  },
  headers: {
    'Authorization': 'Bearer jwt_token_here',
    'X-Custom-Header': 'custom_value'
  },
  preferredDeviceType: CastDeviceType.ANDROID_TV,
  fallbackStrategy: 'web' // Si Android TV √©choue, ouvrir dans le navigateur
});

// 3. √âcouter les √©v√©nements
universalCasting.addEventListener('deviceDiscovered', (device) => {
  console.log(`üì° Nouvel appareil: ${device.name} (${device.type})`);
});

universalCasting.addEventListener('mediaStateChanged', (state) => {
  console.log(`üéÆ √âtat de lecture: ${state}`);
});
```

## üîß Types d'appareils support√©s

### üì° Chromecast
- **M√©thode** : R√©cepteur web HTML/JS
- **Authentification** : Interception des requ√™tes r√©seau
- **Avantages** : Support natif, stable, r√©pandu
- **Limitations** : N√©cessite un r√©cepteur personnalis√© pour l'auth

### üì∫ Android TV
- **M√©thode** : Application native Android avec ExoPlayer
- **Authentification** : Headers HTTP personnalis√©s
- **Avantages** : Contr√¥le total, performance optimale
- **Limitations** : N√©cessite installation d'une app

### üì± AirPlay (iOS)
- **M√©thode** : API native iOS
- **Authentification** : Int√©gration syst√®me
- **Avantages** : Seamless sur iOS, qualit√© excellente
- **Limitations** : Limit√© √† l'√©cosyst√®me Apple

### üåê DLNA/UPnP
- **M√©thode** : Protocole r√©seau standard
- **Authentification** : Via headers HTTP
- **Avantages** : Compatible avec de nombreux appareils
- **Limitations** : Configuration r√©seau requise

## üõ†Ô∏è Strat√©gies de fallback

### 1. **Fallback Web**
Si aucun appareil de casting n'est trouv√©, ouvre le stream dans un navigateur web avec un player int√©gr√©.

```typescript
fallbackStrategy: 'web'
```

### 2. **Fallback Intent (Android)**
Utilise les intents Android pour ouvrir le stream avec des applications tierces (VLC, Kodi, etc.).

```typescript
fallbackStrategy: 'intent'
```

### 3. **Fallback Native**
Lit le stream directement dans l'application avec un player int√©gr√©.

```typescript
fallbackStrategy: 'native'
```

## üîí Gestion de l'authentification

### M√©thodes d'authentification support√©es

1. **Token dans l'URL**
```typescript
contentId: 'https://stream.m3u8?token=your_token'
```

2. **Token s√©par√©**
```typescript
{
  contentId: 'https://stream.m3u8',
  authToken: 'your_token'
}
```

3. **Headers personnalis√©s**
```typescript
{
  contentId: 'https://stream.m3u8',
  headers: {
    'Authorization': 'Bearer your_token',
    'X-API-Key': 'your_api_key'
  }
}
```

### Fonctionnement de l'authentification par appareil

| Appareil | M√©thode | Description |
|----------|---------|-------------|
| Chromecast | Interception JS | Le r√©cepteur web intercepte toutes les requ√™tes et ajoute le token |
| Android TV | Headers HTTP | ExoPlayer configur√© avec headers d'authentification |
| AirPlay | Token URL | Le token est inclus dans l'URL du stream |
| DLNA | Headers HTTP | Les headers sont transmis via le protocole UPnP |

## üìä Monitoring et debug

### √âv√©nements disponibles

```typescript
// D√©couverte d'appareils
universalCasting.addEventListener('deviceDiscovered', (device) => {
  console.log('Appareil trouv√©:', device);
});

// Perte d'appareils
universalCasting.addEventListener('deviceLost', (deviceId) => {
  console.log('Appareil perdu:', deviceId);
});

// √âtat de connexion
universalCasting.addEventListener('connectionStateChanged', (state) => {
  console.log('√âtat connexion:', state); // connected, disconnected, connecting, error
});

// √âtat de lecture
universalCasting.addEventListener('mediaStateChanged', (state) => {
  console.log('√âtat m√©dia:', state); // playing, paused, buffering, idle, error
});

// Progression
universalCasting.addEventListener('mediaProgress', (progress) => {
  console.log(`Progression: ${progress.position}% (${progress.currentTime}s / ${progress.duration}s)`);
});
```

### Debug et logs

```typescript
// Activer les logs d√©taill√©s
console.log('Mode debug activ√©');

// Les logs apparaissent automatiquement dans la console
// et sur l'interface des r√©cepteurs (web et Android TV)
```

## üß™ Tests et validation

### 1. Test du r√©cepteur web
```bash
cd universal-receiver/web
npm test  # Ouvre l'interface de test interactive
```

### 2. Test de l'app Android TV
```bash
cd universal-receiver/android-tv
./gradlew connectedAndroidTest
```

### 3. Test d'int√©gration
```typescript
import { universalCasting } from './universal-casting';

async function testUniversalCasting() {
  // Test de d√©couverte
  const devices = await universalCasting.discoverDevices();
  console.log(`‚úÖ ${devices.length} appareil(s) d√©couvert(s)`);
  
  // Test de casting
  const testStreams = [
    'https://demo.unified-streaming.com/k8s/features/stable/video/tears-of-steel/tears-of-steel.ism/.m3u8',
    'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4'
  ];
  
  for (const stream of testStreams) {
    const result = await universalCasting.castStream({
      contentId: stream,
      metadata: { title: `Test Stream ${stream}` }
    });
    
    console.log(`Stream ${stream}: ${result.success ? '‚úÖ' : '‚ùå'}`);
  }
}

testUniversalCasting();
```

## üîß Configuration avanc√©e

### Personnaliser les types d'appareils d√©tect√©s

```typescript
import { UniversalCasting, CastDeviceType } from './universal-casting';

const casting = UniversalCasting.getInstance();

// D√©sactiver certains types d'appareils
const devices = await casting.discoverDevices();
const filteredDevices = devices.filter(device => 
  device.type !== CastDeviceType.DLNA // Exclure DLNA
);
```

### Ajouter des headers d'authentification personnalis√©s

```typescript
const result = await universalCasting.castStream({
  contentId: 'https://secure-stream.m3u8',
  headers: {
    'Authorization': 'Bearer ' + getJWTToken(),
    'X-Device-ID': getDeviceId(),
    'X-Session-ID': getSessionId(),
    'User-Agent': 'MyApp/1.0'
  }
});
```

### Configurer les timeouts et retry

```typescript
// Configuration globale (√† impl√©menter)
const options = {
  discoveryTimeout: 10000,  // 10 secondes
  connectionTimeout: 15000, // 15 secondes
  maxRetries: 3,
  retryDelay: 2000         // 2 secondes
};
```

## üÜò D√©pannage

### Probl√®mes fr√©quents

**1. "Aucun appareil trouv√©"**
- V√©rifiez que les appareils sont sur le m√™me r√©seau
- Assurez-vous que le WiFi est activ√©
- Red√©marrez la d√©couverte d'appareils

**2. "√âchec de casting Chromecast"**
- V√©rifiez que le r√©cepteur web est d√©ploy√© en HTTPS
- Contr√¥lez l'App ID dans Google Cast Console
- Ajoutez votre appareil comme device de test

**3. "Application Android TV non trouv√©e"**
- Installez l'APK sur l'Android TV
- V√©rifiez les permissions dans le manifeste
- Testez avec un intent direct

**4. "Authentification √©choue"**
- V√©rifiez que le token est valide
- Contr√¥lez les headers dans les requ√™tes r√©seau
- Testez l'URL directement dans un navigateur

### Debug avanc√©

```bash
# Chromecast - Console du r√©cepteur
# Ouvrez https://votre-recepteur.com dans Chrome
# F12 ‚Üí Console ‚Üí Voir les logs

# Android TV - Logs syst√®me
adb logcat | grep UniversalReceiver

# iOS - Console Xcode
# Window ‚Üí Devices and Simulators ‚Üí Voir les logs

# R√©seau - Wireshark
# Capturer le trafic r√©seau pour diagnostiquer les requ√™tes
```

## ü§ù Contribution

1. Fork le projet
2. Cr√©er une branche (`git checkout -b feature/amazing-feature`)
3. Commit (`git commit -m 'Add amazing feature'`)
4. Push (`git push origin feature/amazing-feature`)
5. Ouvrir une Pull Request

## üìÑ Licence

Ce projet est sous licence MIT. Voir le fichier `LICENSE` pour plus de d√©tails.

## üéâ Remerciements

- Google Cast SDK pour l'infrastructure Chromecast
- ExoPlayer pour le player Android haute performance
- La communaut√© open source pour les outils et librairies

---

**üéØ Maintenant vous avez un syst√®me de casting vraiment universel qui fonctionne partout !** 