<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©cepteur Universel HLS S√©curis√©</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }
        
        #video-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #video-player {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        #device-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
            font-size: 14px;
            z-index: 1000;
            transition: opacity 0.3s;
        }
        
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            padding: 15px 25px;
            border-radius: 25px;
            display: flex;
            gap: 15px;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        #controls.visible {
            opacity: 1;
        }
        
        .control-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }
        
        .control-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        #progress-bar {
            width: 200px;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            overflow: hidden;
        }
        
        #progress-fill {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.3s;
        }
        
        #debug-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #FF9800;
            font-size: 12px;
            font-family: monospace;
            max-width: 300px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            opacity: 0.7;
        }
        
        #loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255,255,255,0.3);
            border-top: 6px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        .device-chromecast { border-left-color: #4285F4; }
        .device-android-tv { border-left-color: #34A853; }
        .device-smart-tv { border-left-color: #EA4335; }
        .device-web { border-left-color: #FBBC05; }
        
        .status-playing { color: #4CAF50; }
        .status-buffering { color: #FF9800; }
        .status-error { color: #F44336; }
        .status-idle { color: #9E9E9E; }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="loading-spinner"></div>
        <div id="loading-text">Initialisation du r√©cepteur universel...</div>
    </div>
    
    <div id="video-container">
        <video id="video-player" preload="metadata" muted playsinline></video>
    </div>
    
    <div id="device-info">
        <div><strong>üé¨ R√©cepteur Universel HLS</strong></div>
        <div id="device-type">D√©tection en cours...</div>
        <div id="device-status" class="status-idle">En attente</div>
        <div id="stream-info"></div>
    </div>
    
    <div id="controls">
        <button class="control-btn" id="play-pause-btn">‚è∏Ô∏è</button>
        <div id="progress-bar">
            <div id="progress-fill"></div>
        </div>
        <button class="control-btn" id="volume-btn">üîä</button>
        <button class="control-btn" id="fullscreen-btn">‚õ∂</button>
    </div>
    
    <div id="debug-panel">
        <div><strong>Debug Logs:</strong></div>
        <div id="debug-logs">D√©marrage...</div>
    </div>

    <!-- Google Cast Framework (conditionnel) -->
    <script>
        // D√©tection d'environnement
        const Environment = {
            isChromecast: () => window.navigator.userAgent.includes('CrKey'),
            isAndroidTV: () => window.navigator.userAgent.includes('Android') && window.navigator.userAgent.includes('TV'),
            isSmartTV: () => window.navigator.userAgent.includes('SmartTV') || window.navigator.userAgent.includes('Tizen'),
            isWebBrowser: () => !Environment.isChromecast() && !Environment.isAndroidTV() && !Environment.isSmartTV()
        };

        // Chargement conditionnel du SDK Google Cast
        if (Environment.isChromecast()) {
            const script = document.createElement('script');
            script.src = 'https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js';
            script.onload = () => initializeChromecast();
            document.head.appendChild(script);
        } else {
            initializeNativePlayer();
        }
    </script>
    
    <script>
        // Variables globales
        let currentEnvironment = null;
        let currentAuthToken = null;
        let videoPlayer = null;
        let debugLogs = [];
        let currentStream = null;
        let castContext = null;
        let playerManager = null;
        
        // √âl√©ments DOM
        const deviceInfo = document.getElementById('device-info');
        const deviceType = document.getElementById('device-type');
        const deviceStatus = document.getElementById('device-status');
        const streamInfo = document.getElementById('stream-info');
        const debugPanel = document.getElementById('debug-logs');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const controls = document.getElementById('controls');
        const videoElement = document.getElementById('video-player');
        
        // Fonction de logging universelle
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            console.log(logEntry);
            debugLogs.push(logEntry);
            
            // Garder seulement les 20 derniers logs
            if (debugLogs.length > 20) {
                debugLogs.shift();
            }
            
            // Mettre √† jour l'affichage
            debugPanel.innerHTML = debugLogs.join('<br>');
            debugPanel.scrollTop = debugPanel.scrollHeight;
        }
        
        // Fonction de mise √† jour du statut
        function updateStatus(status, type = 'info') {
            deviceStatus.textContent = status;
            deviceStatus.className = `status-${type}`;
            log(`Status: ${status}`, type);
        }
        
        // Fonction de mise √† jour des informations de stream
        function updateStreamInfo(info) {
            streamInfo.innerHTML = info;
        }
        
        // D√©tection et initialisation de l'environnement
        function detectEnvironment() {
            if (Environment.isChromecast()) {
                currentEnvironment = 'chromecast';
                deviceType.textContent = 'üì° Google Chromecast';
                deviceInfo.className = 'device-chromecast';
                return 'chromecast';
            } else if (Environment.isAndroidTV()) {
                currentEnvironment = 'android-tv';
                deviceType.textContent = 'üì∫ Android TV';
                deviceInfo.className = 'device-android-tv';
                return 'android-tv';
            } else if (Environment.isSmartTV()) {
                currentEnvironment = 'smart-tv';
                deviceType.textContent = 'üì± Smart TV';
                deviceInfo.className = 'device-smart-tv';
                return 'smart-tv';
            } else {
                currentEnvironment = 'web';
                deviceType.textContent = 'üåê Navigateur Web';
                deviceInfo.className = 'device-web';
                return 'web';
            }
        }
        
        // Initialisation Chromecast
        function initializeChromecast() {
            log('Initialisation du r√©cepteur Chromecast...');
            
            try {
                castContext = cast.framework.CastReceiverContext.getInstance();
                playerManager = castContext.getPlayerManager();
                
                // Intercepter les requ√™tes LOAD
                playerManager.setMessageInterceptor(
                    cast.framework.messages.MessageType.LOAD,
                    (loadRequestData) => {
                        log('üì® Requ√™te LOAD re√ßue (Chromecast)');
                        return handleLoadRequest(loadRequestData);
                    }
                );
                
                // √âv√©nements du player
                playerManager.addEventListener(
                    cast.framework.events.EventType.PLAYER_STATE_CHANGED,
                    handlePlayerStateChange
                );
                
                playerManager.addEventListener(
                    cast.framework.events.EventType.ERROR,
                    handlePlayerError
                );
                
                // Options du r√©cepteur
                const options = new cast.framework.CastReceiverOptions();
                options.disableIdleTimeout = false;
                options.maxInactivity = 3600;
                
                // D√©marrer le r√©cepteur
                castContext.start(options);
                
                // Configurer les interceptions r√©seau
                setupNetworkInterception();
                
                log('‚úÖ R√©cepteur Chromecast initialis√©');
                updateStatus('R√©cepteur Chromecast pr√™t', 'idle');
                
            } catch (error) {
                log(`‚ùå Erreur initialisation Chromecast: ${error.message}`, 'error');
                updateStatus('Erreur d\'initialisation', 'error');
            }
            
            hideLoading();
        }
        
        // Initialisation player natif
        function initializeNativePlayer() {
            log(`Initialisation du player natif (${currentEnvironment})...`);
            
            videoPlayer = videoElement;
            
            // √âv√©nements du player vid√©o
            videoPlayer.addEventListener('loadstart', () => {
                log('üé¨ D√©but du chargement vid√©o');
                updateStatus('Chargement...', 'buffering');
            });
            
            videoPlayer.addEventListener('loadedmetadata', () => {
                log('üìä M√©tadonn√©es charg√©es');
                updateStreamInfo(`Dur√©e: ${formatTime(videoPlayer.duration)}<br>R√©solution: ${videoPlayer.videoWidth}x${videoPlayer.videoHeight}`);
            });
            
            videoPlayer.addEventListener('canplay', () => {
                log('‚úÖ Pr√™t √† jouer');
                updateStatus('Pr√™t √† jouer', 'idle');
            });
            
            videoPlayer.addEventListener('playing', () => {
                log('‚ñ∂Ô∏è Lecture en cours');
                updateStatus('Lecture en cours', 'playing');
                showControls();
            });
            
            videoPlayer.addEventListener('pause', () => {
                log('‚è∏Ô∏è Pause');
                updateStatus('En pause', 'idle');
            });
            
            videoPlayer.addEventListener('waiting', () => {
                log('‚è≥ Mise en m√©moire tampon...');
                updateStatus('Mise en m√©moire tampon...', 'buffering');
            });
            
            videoPlayer.addEventListener('error', (e) => {
                log(`‚ùå Erreur vid√©o: ${e.message}`, 'error');
                updateStatus('Erreur de lecture', 'error');
            });
            
            videoPlayer.addEventListener('ended', () => {
                log('üèÅ Fin de la lecture');
                updateStatus('Lecture termin√©e', 'idle');
            });
            
            // Configurer les interceptions r√©seau
            setupNetworkInterception();
            
            // Configurer les contr√¥les
            setupControls();
            
            log('‚úÖ Player natif initialis√©');
            updateStatus('Player natif pr√™t', 'idle');
            
            hideLoading();
        }
        
        // Gestion des requ√™tes LOAD
        function handleLoadRequest(loadRequestData) {
            log('üîç Traitement de la requ√™te LOAD...');
            
            // Extraire les donn√©es personnalis√©es
            const customData = loadRequestData.customData || {};
            currentAuthToken = customData.authToken || null;
            
            if (currentAuthToken) {
                log('üîë Token d\'authentification d√©tect√©');
            } else {
                // Essayer d'extraire le token de l'URL
                const url = loadRequestData.media.contentId;
                const tokenMatch = url.match(/[?&]token=([^&]+)/);
                if (tokenMatch) {
                    currentAuthToken = tokenMatch[1];
                    log('üîë Token extrait de l\'URL');
                }
            }
            
            // Informations sur le stream
            const mediaInfo = loadRequestData.media;
            currentStream = {
                url: mediaInfo.contentId,
                type: mediaInfo.contentType,
                title: mediaInfo.metadata?.title || 'Stream sans titre',
                duration: mediaInfo.duration || 0
            };
            
            log(`üé¨ Stream: ${currentStream.title}`);
            log(`üîó URL: ${currentStream.url}`);
            
            // Configurer le type de m√©dia appropri√©
            if (currentStream.url.includes('.m3u8')) {
                loadRequestData.media.contentType = 'application/x-mpegURL';
                loadRequestData.media.streamType = cast.framework.messages.StreamType.LIVE;
                log('üé• Type HLS configur√©');
            }
            
            updateStreamInfo(`Titre: ${currentStream.title}<br>Type: ${currentStream.type}`);
            
            return loadRequestData;
        }
        
        // Gestion des changements d'√©tat du player
        function handlePlayerStateChange(event) {
            const state = event.playerState;
            log(`üéÆ √âtat du player: ${state}`);
            
            switch (state) {
                case cast.framework.messages.PlayerState.PLAYING:
                    updateStatus('Lecture en cours', 'playing');
                    showControls();
                    break;
                case cast.framework.messages.PlayerState.PAUSED:
                    updateStatus('En pause', 'idle');
                    break;
                case cast.framework.messages.PlayerState.BUFFERING:
                    updateStatus('Mise en m√©moire tampon...', 'buffering');
                    break;
                case cast.framework.messages.PlayerState.IDLE:
                    updateStatus('En attente', 'idle');
                    break;
            }
        }
        
        // Gestion des erreurs du player
        function handlePlayerError(event) {
            const error = event.detailedErrorCode || event.error;
            log(`‚ùå Erreur du player: ${error}`, 'error');
            updateStatus('Erreur de lecture', 'error');
        }
        
        // Configuration des interceptions r√©seau
        function setupNetworkInterception() {
            log('üîß Configuration des interceptions r√©seau...');
            
            // Sauvegarder les fonctions originales
            const originalFetch = window.fetch;
            const originalXMLHttpRequest = window.XMLHttpRequest;
            
            // Intercepter fetch
            window.fetch = function(input, init = {}) {
                const url = typeof input === 'string' ? input : input.url;
                
                if (currentAuthToken && isMediaSegment(url)) {
                    const newUrl = addTokenToUrl(url, currentAuthToken);
                    log(`üîó Token ajout√© √†: ${url.split('?')[0]}`);
                    
                    if (typeof input === 'string') {
                        input = newUrl;
                    } else {
                        input = new Request(newUrl, input);
                    }
                }
                
                return originalFetch.call(this, input, init);
            };
            
            // Intercepter XMLHttpRequest
            window.XMLHttpRequest = function() {
                const xhr = new originalXMLHttpRequest();
                const originalOpen = xhr.open;
                
                xhr.open = function(method, url, async, user, password) {
                    if (currentAuthToken && isMediaSegment(url)) {
                        url = addTokenToUrl(url, currentAuthToken);
                        log(`üîó Token ajout√© √†: ${url.split('?')[0]}`);
                    }
                    
                    return originalOpen.call(this, method, url, async, user, password);
                };
                
                return xhr;
            };
            
            log('‚úÖ Interceptions r√©seau configur√©es');
        }
        
        // V√©rifier si une URL est un segment m√©dia
        function isMediaSegment(url) {
            return url.includes('.ts') || url.includes('.m4s') || url.includes('.m3u8');
        }
        
        // Ajouter le token √† une URL
        function addTokenToUrl(url, token) {
            if (url.includes('token=')) {
                return url; // Token d√©j√† pr√©sent
            }
            
            const separator = url.includes('?') ? '&' : '?';
            return `${url}${separator}token=${token}`;
        }
        
        // Configuration des contr√¥les
        function setupControls() {
            const playPauseBtn = document.getElementById('play-pause-btn');
            const volumeBtn = document.getElementById('volume-btn');
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            const progressBar = document.getElementById('progress-bar');
            const progressFill = document.getElementById('progress-fill');
            
            // Bouton play/pause
            playPauseBtn.addEventListener('click', () => {
                if (videoPlayer.paused) {
                    videoPlayer.play();
                    playPauseBtn.textContent = '‚è∏Ô∏è';
                } else {
                    videoPlayer.pause();
                    playPauseBtn.textContent = '‚ñ∂Ô∏è';
                }
            });
            
            // Bouton volume
            volumeBtn.addEventListener('click', () => {
                videoPlayer.muted = !videoPlayer.muted;
                volumeBtn.textContent = videoPlayer.muted ? 'üîá' : 'üîä';
            });
            
            // Bouton plein √©cran
            fullscreenBtn.addEventListener('click', () => {
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                } else {
                    videoPlayer.requestFullscreen();
                }
            });
            
            // Barre de progression
            progressBar.addEventListener('click', (e) => {
                const rect = progressBar.getBoundingClientRect();
                const progress = (e.clientX - rect.left) / rect.width;
                videoPlayer.currentTime = progress * videoPlayer.duration;
            });
            
            // Mise √† jour de la barre de progression
            videoPlayer.addEventListener('timeupdate', () => {
                if (videoPlayer.duration > 0) {
                    const progress = (videoPlayer.currentTime / videoPlayer.duration) * 100;
                    progressFill.style.width = `${progress}%`;
                }
            });
        }
        
        // Afficher les contr√¥les
        function showControls() {
            controls.classList.add('visible');
            setTimeout(() => {
                controls.classList.remove('visible');
            }, 5000);
        }
        
        // Masquer le loading
        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }
        
        // Formater le temps
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${minutes}:${secs.toString().padStart(2, '0')}`;
            }
        }
        
        // Fonction pour charger un stream (appel√©e depuis l'ext√©rieur)
        window.loadStream = function(url, token, metadata = {}) {
            log(`üé¨ Chargement du stream: ${url}`);
            
            currentAuthToken = token;
            currentStream = {
                url: url,
                title: metadata.title || 'Stream',
                type: metadata.contentType || 'application/x-mpegURL'
            };
            
            if (currentEnvironment === 'chromecast') {
                // Le stream sera charg√© via Cast SDK
                log('Stream sera charg√© via Cast SDK');
            } else {
                // Charger directement dans le player vid√©o
                videoPlayer.src = url;
                videoPlayer.load();
                log('Stream charg√© dans le player natif');
            }
            
            updateStreamInfo(`Titre: ${currentStream.title}<br>URL: ${url}`);
        };
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Initialisation du r√©cepteur universel...');
            
            const environment = detectEnvironment();
            log(`üîç Environnement d√©tect√©: ${environment}`);
            
            loadingText.textContent = `Initialisation pour ${environment}...`;
            
            // L'initialisation sp√©cifique se fait dans les callbacks des scripts
        });
        
        // Gestion des messages personnalis√©s (pour communication avec l'app)
        window.addEventListener('message', (event) => {
            log(`üì® Message re√ßu: ${JSON.stringify(event.data)}`);
            
            const { type, data } = event.data;
            
            switch (type) {
                case 'LOAD_STREAM':
                    window.loadStream(data.url, data.token, data.metadata);
                    break;
                case 'PLAY':
                    if (videoPlayer) videoPlayer.play();
                    break;
                case 'PAUSE':
                    if (videoPlayer) videoPlayer.pause();
                    break;
                case 'SEEK':
                    if (videoPlayer) videoPlayer.currentTime = data.time;
                    break;
                case 'SET_VOLUME':
                    if (videoPlayer) videoPlayer.volume = data.volume;
                    break;
            }
        });
        
        // Afficher/masquer les panneaux de debug avec des raccourcis clavier
        document.addEventListener('keydown', (e) => {
            if (e.key === 'd' && e.ctrlKey) {
                e.preventDefault();
                const isVisible = debugPanel.style.display !== 'none';
                debugPanel.style.display = isVisible ? 'none' : 'block';
            }
        });
        
        // Masquer automatiquement les contr√¥les et infos apr√®s un certain temps
        let hideTimeout;
        document.addEventListener('mousemove', () => {
            showControls();
            deviceInfo.style.opacity = '1';
            
            clearTimeout(hideTimeout);
            hideTimeout = setTimeout(() => {
                deviceInfo.style.opacity = '0.3';
            }, 3000);
        });
        
    </script>
</body>
</html> 