<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RÃ©cepteur Chromecast HLS SÃ©curisÃ©</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        
        #player {
            width: 100%;
            height: 100%;
        }
        
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 1000;
        }
        
        #debug {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 300px;
            z-index: 1000;
        }
        
        .status {
            color: #00ff00;
        }
        
        .error {
            color: #ff0000;
        }
        
        .warning {
            color: #ffaa00;
        }
    </style>
</head>
<body>
    <div id="info">
        <div>ðŸŽ¬ RÃ©cepteur HLS SÃ©curisÃ©</div>
        <div id="status" class="status">En attente...</div>
    </div>
    
    <div id="player"></div>
    
    <div id="debug">
        <div><strong>Debug:</strong></div>
        <div id="debug-content">Aucune information</div>
    </div>

    <!-- Google Cast Framework -->
    <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    
    <script>
        // Configuration du rÃ©cepteur
        const context = cast.framework.CastReceiverContext.getInstance();
        const playerManager = context.getPlayerManager();
        
        // Variables globales pour le debug
        let currentAuthToken = null;
        let debugElement = document.getElementById('debug-content');
        let statusElement = document.getElementById('status');
        
        // Fonction utilitaire pour logger
        function log(message, type = 'info') {
            console.log(`[HLS-RECEIVER] ${message}`);
            const now = new Date().toLocaleTimeString();
            debugElement.innerHTML = `[${now}] ${message}<br>` + debugElement.innerHTML.split('<br>').slice(0, 5).join('<br>');
            
            if (type === 'status') {
                statusElement.textContent = message;
                statusElement.className = 'status';
            } else if (type === 'error') {
                statusElement.textContent = message;
                statusElement.className = 'error';
            } else if (type === 'warning') {
                statusElement.textContent = message;
                statusElement.className = 'warning';
            }
        }
        
        // Intercepter les requÃªtes LOAD pour extraire le token
        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.LOAD,
            (loadRequestData) => {
                log('ðŸ“¨ RequÃªte LOAD reÃ§ue', 'status');
                
                // Extraire les donnÃ©es personnalisÃ©es
                const customData = loadRequestData.customData || {};
                log(`ðŸ” CustomData: ${JSON.stringify(customData)}`);
                
                // Extraire le token d'authentification
                currentAuthToken = customData.authToken || null;
                
                if (currentAuthToken) {
                    log(`ðŸ”‘ Token d'authentification dÃ©tectÃ©`, 'status');
                    
                    // Extraire le token de l'URL si pas dans customData
                    if (!currentAuthToken && loadRequestData.media && loadRequestData.media.contentId) {
                        const url = loadRequestData.media.contentId;
                        const tokenMatch = url.match(/[?&]token=([^&]+)/);
                        if (tokenMatch) {
                            currentAuthToken = tokenMatch[1];
                            log(`ðŸ”‘ Token extrait de l'URL`);
                        }
                    }
                } else {
                    log(`âš ï¸ Aucun token d'authentification trouvÃ©`, 'warning');
                }
                
                // Modifier l'URL du mÃ©dia si nÃ©cessaire
                if (loadRequestData.media && loadRequestData.media.contentId) {
                    const originalUrl = loadRequestData.media.contentId;
                    log(`ðŸŽ¬ MÃ©dia original: ${originalUrl}`);
                    
                    // VÃ©rifier si c'est un flux HLS
                    if (originalUrl.includes('.m3u8')) {
                        log(`ðŸŽ¥ Flux HLS dÃ©tectÃ©`);
                        
                        // Configurer le type de mÃ©dia appropriÃ©
                        loadRequestData.media.contentType = 'application/x-mpegURL';
                        loadRequestData.media.streamType = cast.framework.messages.StreamType.LIVE;
                        
                        log(`âœ… Configuration HLS appliquÃ©e`);
                    }
                }
                
                return loadRequestData;
            }
        );
        
        // Intercepter les erreurs de chargement
        playerManager.addEventListener(
            cast.framework.events.EventType.ERROR,
            (event) => {
                log(`âŒ Erreur: ${event.detailedErrorCode || event.error}`, 'error');
            }
        );
        
        // Intercepter les changements d'Ã©tat du player
        playerManager.addEventListener(
            cast.framework.events.EventType.PLAYER_STATE_CHANGED,
            (event) => {
                const state = event.playerState;
                log(`ðŸŽ® Ã‰tat du player: ${state}`, 'status');
                
                if (state === cast.framework.messages.PlayerState.PLAYING) {
                    log(`â–¶ï¸ Lecture en cours`, 'status');
                } else if (state === cast.framework.messages.PlayerState.BUFFERING) {
                    log(`â³ Mise en mÃ©moire tampon...`, 'status');
                } else if (state === cast.framework.messages.PlayerState.IDLE) {
                    log(`â¹ï¸ Player en veille`, 'status');
                }
            }
        );
        
        // Intercepter le chargement des mÃ©dias
        playerManager.addEventListener(
            cast.framework.events.EventType.MEDIA_STATUS_CHANGED,
            (event) => {
                log(`ðŸ“º Statut mÃ©dia changÃ©`);
            }
        );
        
        // FONCTIONNALITÃ‰ PRINCIPALE : Intercepter les requÃªtes rÃ©seau pour ajouter le token
        // Cette partie est cruciale pour l'authentification HLS
        const originalXMLHttpRequest = window.XMLHttpRequest;
        const originalFetch = window.fetch;
        
        // Intercepter XMLHttpRequest (utilisÃ© par certains players HLS)
        window.XMLHttpRequest = function() {
            const xhr = new originalXMLHttpRequest();
            const originalOpen = xhr.open;
            
            xhr.open = function(method, url, async, user, password) {
                // VÃ©rifier si c'est une requÃªte de segment HLS
                if (currentAuthToken && (url.includes('.ts') || url.includes('.m4s') || url.includes('.m3u8'))) {
                    // Ajouter le token Ã  l'URL si pas dÃ©jÃ  prÃ©sent
                    if (!url.includes('token=')) {
                        const separator = url.includes('?') ? '&' : '?';
                        url = `${url}${separator}token=${currentAuthToken}`;
                        log(`ðŸ”— Token ajoutÃ© Ã : ${url.split('?')[0]}`);
                    }
                }
                
                return originalOpen.call(this, method, url, async, user, password);
            };
            
            return xhr;
        };
        
        // Intercepter fetch (API moderne)
        window.fetch = function(input, init = {}) {
            let url = typeof input === 'string' ? input : input.url;
            
            // VÃ©rifier si c'est une requÃªte de segment HLS
            if (currentAuthToken && (url.includes('.ts') || url.includes('.m4s') || url.includes('.m3u8'))) {
                // Ajouter le token Ã  l'URL si pas dÃ©jÃ  prÃ©sent
                if (!url.includes('token=')) {
                    const separator = url.includes('?') ? '&' : '?';
                    url = `${url}${separator}token=${currentAuthToken}`;
                    log(`ðŸ”— Token ajoutÃ© Ã : ${url.split('?')[0]}`);
                }
                
                // Mettre Ã  jour l'URL
                if (typeof input === 'string') {
                    input = url;
                } else {
                    input = new Request(url, input);
                }
            }
            
            return originalFetch.call(this, input, init);
        };
        
        // Configuration des options du rÃ©cepteur
        const options = new cast.framework.CastReceiverOptions();
        
        // Configurer le timeout de dÃ©connexion (optionnel)
        options.disableIdleTimeout = false;
        options.maxInactivity = 3600; // 1 heure
        
        // Ajouter des namespaces personnalisÃ©s si nÃ©cessaire
        options.customNamespaces = {};
        
        // DÃ©marrer le rÃ©cepteur
        context.start(options);
        
        log('ðŸš€ RÃ©cepteur HLS sÃ©curisÃ© dÃ©marrÃ©', 'status');
        
        // Debug: Afficher les informations systÃ¨me
        setTimeout(() => {
            const systemInfo = context.getSystemInfo();
            log(`ðŸ“± SystÃ¨me: ${systemInfo.displayName || 'Chromecast'}`);
        }, 1000);
        
    </script>
</body>
</html> 